#include <arm_neon.h>
#include <stdio.h>

// gcc -o test reduction_test.c -O3; ./test

#define FALCON_Q 12289
#define FALCON_QINV (-12287)
#define FALCON_MONT 4091

const int16_t ntt1024[] = {0, -1479, -5146, 4043, -1305, 722, 5736, -4134, 3542, -3504, -2545, 3621, -1646, 1212, 3195, 5860, -4821, 2639, -2625, -949, -563, -2975, -3006, -2744, 5728, -4591, 5023, 5828, -3328, -5777, -4978, 1351, 2319, -1170, -955, -790, -3201, 3014, 5086, -1326, 4846, -2747, -3135, 3712, 4805, -3553, -1062, -2294, 3091, -81, -4320, -1000, -2963, -4896, -3051, 2366, -1177, -4255, -1635, -2768, -140, -1853, -4611, -726, 1260, 4388, 4632, -5755, 2426, 334, 1428, 1696, 2013, -3289, 729, 3241, 2881, 3284, -5092, -2089, -3694, -5179, -1759, -3707, 3382, -355, -2548, -4231, 3637, 3459, 145, -5542, -2731, -3932, -4890, -5911, -2842, 480, 1022, 9, -2468, 339, 5791, 544, -1673, 4278, -5331, -4989, -4177, -3584, 1381, -2525, -953, -3748, 827, 5767, 2476, 118, 2197, -5067, 3949, -3296, 4452, 2396, -4354, 130, 2837, -5374, 2401, 442, -5101, -1067, 390, 773, -3833, 3778, 354, 4861, -2912, 5698, 5012, -2481, 2859, -1045, 1017, -4885, 1632, -5084, 27, -3066, -3763, -1440, 1537, 242, 4714, -4143, -2678, 3704, 5019, -545, 1002, 5011, 5088, -4284, -4976, -1607, -3780, -875, -2437, 3646, 6022, 2987, -2566, -2187, -6039, -2422, -1065, 2143, -404, -4645, 1168, 5277, -1207, 3248, 493, -4096, -5444, 2381, -4337, -435, 1378, 1912, 2166, 3915, -113, -4919, -160, 3149, -3, 4437, 3636, 4938, 5291, 2704, -1426, -4654, 1663, -1777, 3364, 1689, 4057, -3271, -2847, -4414, 2174, 4372, -5042, -2305, 4053, 2645, 5195, -2780, -4895, 1484, -3247, -2686, -3978, -2969, -2370, 2865, 5332, 3510, 1630, -2126, 5407, 3186, -1153, -2884, -2249, -4048, -2399, -3400, -5191, -3136, -3000, 671, 3016, 243, -5559, 420, -2178, 1544, 3985, 4905, 3531, 476, 49, 1263, 5915, 1483, -2500, -1489, -1583, -5942, 1512, 350, -1815, 5383, 5369, -2057, -3202, 4493, -2738, -5868, -5735, 2655, -3009, 1693, 174, 723, -1975, -3757, 347, 2925, -3315, -426, 1858, 4754, 3030, 4115, 2361, -1843, 2908, 218, 3434, -3529, 3963, 576, 6142, -2447, 1954, -2051, -2882, -1805, 3991, -3969, -2767, 156, 2281, 5876, -2031, 5333, 3772, 418, 5908, -453, 5429, -4774, -4737, 1293, 295, 6099, 5766, 652, -4016, 4077, -3762, -2919, 325, -1404, -1146, -948, 5990, 1159, -3728, -4049, 3329, 4298, -168, 2692, 5961, -5106, -1962, 1594, -6122, -2555, -5184, -1200, 1360, 3956, -6119, 5297, -4079, -1058, 922, 441, 1958, 4322, 1112, 2078, 4046, 709, -3150, 1319, 4240, -3570, -6065, -835, 2459, 683, 3656, -64, -1566, 5782, -2948, -2503, -3123, -1747, -3054, -5486, -4433, -5919, 3834, -5257, -5241, -2920, -4169, -3127, -5468, 1010, -3482, 787, 5057, 4698, 4780, -3445, -192, 1321, 4912, -2049, 677, -5874, -6055, -3336, 1323, -2766, -52, 3174, 1579, -431, -2505, 5906, 3957, -2839, 151, -2127, -58, -241, 3532, -1003, 1956, -5009, -885, -6008, 3477, -5681, 142, -1105, -2844, 3438, -975, 4212, -3029, -5594, 4782, 5886, -4213, 504, 2302, -605, -421, -4080, 3602, 6068, -3600, 3263, 6077, -4624, -4467, -4789, -5537, 4749, 4449, -5456, -147, -3789, 6118, -3818, 1190, -2683, 3860, 5445, -4536, -1050, 5079, -3262, 2169, -522, -4324, 4916, -4075, 5315, -1278, -2344, 1973, -5574, -3514, -1041, 5925, -1018, 654, 3565, 1702, 1987, -5529, 5206, 3199, -56, 6136, -5862, -5415, -3643, 4948, -6137, 400, -1728, 5339, 5446, 3710, 6093, 468, -3988, 316, -382, -2033, -3998, 3879, 1922, -1359, -5435, 973, -1254, 7, 1936, 845, 3723, 3154, 5054, 3285, -4360, 216, 50, -5526, 769, 767, -3805, -2213, 4153, 3120, -6105, -6086, 5646, -3941, 3753, 3536, 5370, 3229, 4730, -1706, 3929, 1282, -3572, 2021, -2832, 3944, 4099, 5604, -5530, 2171, -3480, -1265, 3007, -2945, 5349, 2633, 1406, -3232, -293, 4855, -3769, -2941, -567, -5662, 5289, 3837, 2595, 3221, 4273, 4050, -5207, 844, 5202, -980, -682, 4590, -5082, -3469, 6138, -4443, -3418, 4693, 2338, -2293, -417, 1802, 1555, 5103, -1891, -4411, -1590, 1223, -2334, -1280, 614, -24, -1371, -904, -2485, -5547, -5039, 881, -365, 1015, -1927, 5461, -2946, 2637, -4510, 4684, 3360, -5135, 63, -4987, 2373, 3670, 3808, 578, 5368, -450, 1944, -4661, -510, -2622, -5386, 5618, -1658, 5789, 3502, 5043, 826, 3090, 1398, 3065, 1506, -5703, 4483, -5900, 910, -4719, -751, 4518, 3094, 1160, 4820, 2730, 5411, -2253, 1868, 2478, -2840, 4194, 3019, -1783, -5078, -4565, 4974, -5170, 2672, -865, 1279, 189, 3116, -1763, 2209, -1530, 1694, -3869, -4423, 5832, 1350, -1734, -3815, -5275, -1790, -1251, -5410, 2035, 1040, -1882, -6125, -4770, 944, 5287, -3669, -5673, -3020, -5406, -4665, 4834, 2712, -2828, 4352, -4113, 72, 3840, -1842, 3451, -4094, -1241, 4378, -5781, -3045, -2643, 1095, 2873, 2827, -791, 2434, -1120, -2535, -21, -5808, 874, -2301, 170, -5650, 2307, 4289, -648, -150, -1030, -466, 3821, 1681, 4649, 5969, 2929, 6026, 1573, -3846, 3793, -6063, -502, 5118, 2602, -1901, 1849, 5776, -3268, 3795, -4301, -4523, 457, -8, -879, -2593, 982, -2276, 4218, 4390, -3454, -3758, -4504, 778, 530, 2626, 3578, 4697, -3466, 1701, -2046, 2940, -2957, -1481, 3317, -2532, 139, 3332, 343, -3448, 4538, -1908, -5211, 1866, 1208, -4727, -1705, 2450, -416, 814, 716, -2110, 2164, -5416, 5412, -4209, -3278, -5993, 3515, -438, 1218, 5061, -1536, -1721, 2429, -4103, 1373, -2982, 717, -3589, -3368, 4227, 4238, -612, -4222, 1526, -540, -125, 3163, 4032, 6127, -4840, 1389, -2068, 4404, -346, 3359, -3205, 5209, 1092, 3678, 4265, -1928, 464, 1826, 2926, 4489, -3171, 1136, 3449, 3708, -3238, 2065, 5826, 3495, 4564, -3534, 3961, -1756, 4145, 2275, 2461, 4267, 5653, 5063, -4176, -1518, -3765, -1275, 5508, -1176, -5734, 4860, 1125, -1445, -1131, -5987, -5596, 579, 3889, -2769, 3114, -5966, 212, -3975, 4883, -5835, 3087, 1417, 5676, -4505, 2257, 3744, 4963, 2528, -3056, 5102, -412, -5588, -5845, 4924, 4781, 1014, -448, 1327, 3607, 3942, -5232, 2717, 60, 3200, -1535, 5836, -4566, 2260, 68, 180, 4138, -4605, 2689, -1409, -5219, 204, 5509, -1468, -3981, -3407, 463, -1344, -3042, -2483, -2054, 4739, -4251, -5518, 1226, -3028, 5216, -364, -2360, -1236, -3017, -5246, 4475, 3121, 4705, 1057, -2600, -406, -1687, 146, 5268, 1403, 1804, 6094, -5189, -239, -2900, 994, 4554, 4670, -512, 5464, 4906, 3375, -2291, -3393, 4335, -4913, 3528, 3825, -4235, -2947, -3982, 636, 5609, -622, -1737, 5672, 4499, 5598, 3344, -1892, -3624, -5724, -1325, -1029, -1945, 5959, -2148, -3959, 5797, 2442, 1248, 5115, 4939, -1314, 1744, 2894, -3654, -5690, -2455, -3947, 338, 3343, -4119, 1522, -2151, -20, 5002, 4608, 5163, 4578, 377, -375, 1620, -1836, -425, -2185, -392, 6085, -4167, -1038, -923, -2231, -6092, 2800, 193, 506, 1255, 1392, 5784, 3276, -3338, 2212, -2674, -1942, -3408, 2575, 1165, 2776, -1178, -5478, 3511};
const int16_t intt1024[] = {0, 1479, -4043, 5146, 4134, -5736, -722, 1305, -5860, -3195, -1212, 1646, -3621, 2545, 3504, -3542, -1351, 4978, 5777, 3328, -5828, -5023, 4591, -5728, 2744, 3006, 2975, 563, 949, 2625, -2639, 4821, 726, 4611, 1853, 140, 2768, 1635, 4255, 1177, -2366, 3051, 4896, 2963, 1000, 4320, 81, -3091, 2294, 1062, 3553, -4805, -3712, 3135, 2747, -4846, 1326, -5086, -3014, 3201, 790, 955, 1170, -2319, 5374, -2837, -130, 4354, -2396, -4452, 3296, -3949, 5067, -2197, -118, -2476, -5767, -827, 3748, 953, 2525, -1381, 3584, 4177, 4989, 5331, -4278, 1673, -544, -5791, -339, 2468, -9, -1022, -480, 2842, 5911, 4890, 3932, 2731, 5542, -145, -3459, -3637, 4231, 2548, 355, -3382, 3707, 1759, 5179, 3694, 2089, 5092, -3284, -2881, -3241, -729, 3289, -2013, -1696, -1428, -334, -2426, 5755, -4632, -4388, -1260, -476, -3531, -4905, -3985, -1544, 2178, -420, 5559, -243, -3016, -671, 3000, 3136, 5191, 3400, 2399, 4048, 2249, 2884, 1153, -3186, -5407, 2126, -1630, -3510, -5332, -2865, 2370, 2969, 3978, 2686, 3247, -1484, 4895, 2780, -5195, -2645, -4053, 2305, 5042, -4372, -2174, 4414, 2847, 3271, -4057, -1689, -3364, 1777, -1663, 4654, 1426, -2704, -5291, -4938, -3636, -4437, 3, -3149, 160, 4919, 113, -3915, -2166, -1912, -1378, 435, 4337, -2381, 5444, 4096, -493, -3248, 1207, -5277, -1168, 4645, 404, -2143, 1065, 2422, 6039, 2187, 2566, -2987, -6022, -3646, 2437, 875, 3780, 1607, 4976, 4284, -5088, -5011, -1002, 545, -5019, -3704, 2678, 4143, -4714, -242, -1537, 1440, 3763, 3066, -27, 5084, -1632, 4885, -1017, 1045, -2859, 2481, -5012, -5698, 2912, -4861, -354, -3778, 3833, -773, -390, 1067, 5101, -442, -2401, 1254, -973, 5435, 1359, -1922, -3879, 3998, 2033, 382, -316, 3988, -468, -6093, -3710, -5446, -5339, 1728, -400, 6137, -4948, 3643, 5415, 5862, -6136, 56, -3199, -5206, 5529, -1987, -1702, -3565, -654, 1018, -5925, 1041, 3514, 5574, -1973, 2344, 1278, -5315, 4075, -4916, 4324, 522, -2169, 3262, -5079, 1050, 4536, -5445, -3860, 2683, -1190, 3818, -6118, 3789, 147, 5456, -4449, -4749, 5537, 4789, 4467, 4624, -6077, -3263, 3600, -6068, -3602, 4080, 421, 605, -2302, -504, 4213, -5886, -4782, 5594, 3029, -4212, 975, -3438, 2844, 1105, -142, 5681, -3477, 6008, 885, 5009, -1956, 1003, -3532, 241, 58, 2127, -151, 2839, -3957, -5906, 2505, 431, -1579, -3174, 52, 2766, -1323, 3336, 6055, 5874, -677, 2049, -4912, -1321, 192, 3445, -4780, -4698, -5057, -787, 3482, -1010, 5468, 3127, 4169, 2920, 5241, 5257, -3834, 5919, 4433, 5486, 3054, 1747, 3123, 2503, 2948, -5782, 1566, 64, -3656, -683, -2459, 835, 6065, 3570, -4240, -1319, 3150, -709, -4046, -2078, -1112, -4322, -1958, -441, -922, 1058, 4079, -5297, 6119, -3956, -1360, 1200, 5184, 2555, 6122, -1594, 1962, 5106, -5961, -2692, 168, -4298, -3329, 4049, 3728, -1159, -5990, 948, 1146, 1404, -325, 2919, 3762, -4077, 4016, -652, -5766, -6099, -295, -1293, 4737, 4774, -5429, 453, -5908, -418, -3772, -5333, 2031, -5876, -2281, -156, 2767, 3969, -3991, 1805, 2882, 2051, -1954, 2447, -6142, -576, -3963, 3529, -3434, -218, -2908, 1843, -2361, -4115, -3030, -4754, -1858, 426, 3315, -2925, -347, 3757, 1975, -723, -174, -1693, 3009, -2655, 5735, 5868, 2738, -4493, 3202, 2057, -5369, -5383, 1815, -350, -1512, 5942, 1583, 1489, 2500, -1483, -5915, -1263, -49, -3511, 5478, 1178, -2776, -1165, -2575, 3408, 1942, 2674, -2212, 3338, -3276, -5784, -1392, -1255, -506, -193, -2800, 6092, 2231, 923, 1038, 4167, -6085, 392, 2185, 425, 1836, -1620, 375, -377, -4578, -5163, -4608, -5002, 20, 2151, -1522, 4119, -3343, -338, 3947, 2455, 5690, 3654, -2894, -1744, 1314, -4939, -5115, -1248, -2442, -5797, 3959, 2148, -5959, 1945, 1029, 1325, 5724, 3624, 1892, -3344, -5598, -4499, -5672, 1737, 622, -5609, -636, 3982, 2947, 4235, -3825, -3528, 4913, -4335, 3393, 2291, -3375, -4906, -5464, 512, -4670, -4554, -994, 2900, 239, 5189, -6094, -1804, -1403, -5268, -146, 1687, 406, 2600, -1057, -4705, -3121, -4475, 5246, 3017, 1236, 2360, 364, -5216, 3028, -1226, 5518, 4251, -4739, 2054, 2483, 3042, 1344, -463, 3407, 3981, 1468, -5509, -204, 5219, 1409, -2689, 4605, -4138, -180, -68, -2260, 4566, -5836, 1535, -3200, -60, -2717, 5232, -3942, -3607, -1327, 448, -1014, -4781, -4924, 5845, 5588, 412, -5102, 3056, -2528, -4963, -3744, -2257, 4505, -5676, -1417, -3087, 5835, -4883, 3975, -212, 5966, -3114, 2769, -3889, -579, 5596, 5987, 1131, 1445, -1125, -4860, 5734, 1176, -5508, 1275, 3765, 1518, 4176, -5063, -5653, -4267, -2461, -2275, -4145, 1756, -3961, 3534, -4564, -3495, -5826, -2065, 3238, -3708, -3449, -1136, 3171, -4489, -2926, -1826, -464, 1928, -4265, -3678, -1092, -5209, 3205, -3359, 346, -4404, 2068, -1389, 4840, -6127, -4032, -3163, 125, 540, -1526, 4222, 612, -4238, -4227, 3368, 3589, -717, 2982, -1373, 4103, -2429, 1721, 1536, -5061, -1218, 438, -3515, 5993, 3278, 4209, -5412, 5416, -2164, 2110, -716, -814, 416, -2450, 1705, 4727, -1208, -1866, 5211, 1908, -4538, 3448, -343, -3332, -139, 2532, -3317, 1481, 2957, -2940, 2046, -1701, 3466, -4697, -3578, -2626, -530, -778, 4504, 3758, 3454, -4390, -4218, 2276, -982, 2593, 879, 8, -457, 4523, 4301, -3795, 3268, -5776, -1849, 1901, -2602, -5118, 502, 6063, -3793, 3846, -1573, -6026, -2929, -5969, -4649, -1681, -3821, 466, 1030, 150, 648, -4289, -2307, 5650, -170, 2301, -874, 5808, 21, 2535, 1120, -2434, 791, -2827, -2873, -1095, 2643, 3045, 5781, -4378, 1241, 4094, -3451, 1842, -3840, -72, 4113, -4352, 2828, -2712, -4834, 4665, 5406, 3020, 5673, 3669, -5287, -944, 4770, 6125, 1882, -1040, -2035, 5410, 1251, 1790, 5275, 3815, 1734, -1350, -5832, 4423, 3869, -1694, 1530, -2209, 1763, -3116, -189, -1279, 865, -2672, 5170, -4974, 4565, 5078, 1783, -3019, -4194, 2840, -2478, -1868, 2253, -5411, -2730, -4820, -1160, -3094, -4518, 751, 4719, -910, 5900, -4483, 5703, -1506, -3065, -1398, -3090, -826, -5043, -3502, -5789, 1658, -5618, 5386, 2622, 510, 4661, -1944, 450, -5368, -578, -3808, -3670, -2373, 4987, -63, 5135, -3360, -4684, 4510, -2637, 2946, -5461, 1927, -1015, 365, -881, 5039, 5547, 2485, 904, 1371, 24, -614, 1280, 2334, -1223, 1590, 4411, 1891, -5103, -1555, -1802, 417, 2293, -2338, -4693, 3418, 4443, -6138, 3469, 5082, -4590, 682, 980, -5202, -844, 5207, -4050, -4273, -3221, -2595, -3837, -5289, 5662, 567, 2941, 3769, -4855, 293, 3232, -1406, -2633, -5349, 2945, -3007, 1265, 3480, -2171, 5530, -5604, -4099, -3944, 2832, -2021, 3572, -1282, -3929, 1706, -4730, -3229, -5370, -3536, -3753, 3941, -5646, 6086, 6105, -3120, -4153, 2213, 3805, -767, -769, 5526, -50, -216, 4360, -3285, -5054, -3154, -3723, -845, -1936, -7};
void montgomery_rounding_root(int16_t b, int16_t *broot, int16_t *btwisted)
{
    int32_t root, twisted_root;

    root = (int32_t)b;
    root = (root << 15) % FALCON_Q;
    // Center root is wrong. Don't center root

    // Handle even root
    if ((root & 1) == 0)
    {
        root += FALCON_Q;
    }

    twisted_root = (-root * FALCON_QINV) & 0xFFFF;

    *broot = root;
    *btwisted = twisted_root;
}

void print_array(int16_t *a, int bound, const char *string)
{
    printf("%s = [", string);
    for (int i = 0; i < bound; i++)
    {
        printf("%d, ", a[i]);
    }
    printf("]\n\n");
}

int16_t montgomery_rounding(int16_t a, int16_t broot, int16_t btwisted)
{
    int16x8_t neon_a, neon_z, neon_t;

    // if ( (b == 12265) || (b == 12277) )
    // printf("broot, btwisted: %d %d\n", broot, btwisted);

    neon_a = vdupq_n_s16(a);

    neon_z = vqrdmulhq_n_s16(neon_a, broot);
    neon_a = vmulq_n_s16(neon_a, btwisted);
    neon_z = vqrdmlahq_s16(neon_z, neon_a, vdupq_n_s16(FALCON_Q));

    return neon_z[0];
}

int main()
{
    int16_t n512_inv, n1024_inv, last_layer,
        n512_inv_root, n512_inv_twisted,
        n1024_inv_root, n1024_inv_twisted,
        last_layer_inv_root, last_layer_inv_twisted;
    int16_t min = INT16_MAX, max = INT16_MIN;
    n512_inv = 12265;  // pow(512, -1, q)
    n1024_inv = 12277; // pow(1024, -1, q)
    // Embed N^-1 to last layer
    last_layer = intt1024[1] * n1024_inv % FALCON_Q;

    int16_t broot[1024] = {0};
    int16_t btwisted[1024] = {0};
    for (int i = 0; i < 1024; i++)
    {
        montgomery_rounding_root(intt1024[i], &broot[i], &btwisted[i]);
    }

    // Test barrett and Montgomery
    for (int16_t a = INT16_MIN / 2 + 1; a < INT16_MAX / 2; a++)
    {
        for (int i = 1; i < 1024; i++)
        {
            int16_t gold, test;
            gold = ((int32_t)a * intt1024[i]) % FALCON_Q;
            test = montgomery_rounding(a, broot[i], btwisted[i]);

            if (test < min) min = test;
            if (max < test) max = test;
            // Congruent result
            gold = (gold + FALCON_Q) % FALCON_Q;
            test = (test + FALCON_Q) % FALCON_Q;

            if ( (gold != test) && (gold != test + FALCON_Q) && (gold != test - FALCON_Q) )
            // if (gold != test)
            {
                printf("ERROR %d * [%d](%d): %d != %d\n", a, i, intt1024[i], gold, test);
                return 1;
            }
        }
    }
    printf("max, min = %d, %d\n", max, min);

    // montgomery_rounding_root(n512_inv, &n512_inv_root, &n512_inv_twisted);
    montgomery_rounding_root(n1024_inv, &n1024_inv_root, &n1024_inv_twisted);
    montgomery_rounding_root(last_layer, &last_layer_inv_root, &last_layer_inv_twisted);

    // printf("# 512 : N^-1 * Mont| root (%d) | twisted (%d)\n", n512_inv_root, n512_inv_twisted);

    printf("# Last: coef * N^-1 * Mont| root (%d) | twisted (%d)\n", last_layer_inv_root, last_layer_inv_twisted);
    printf("# 1024: N^-1 * Mont| root (%d) | twisted (%d)\n", n1024_inv_root, n1024_inv_twisted);

    // print_array(broot, 1024, "invntt_mont");
    // print_array(btwisted, 1024, "invntt_qinv_mont");

    /*
     * Remember to edit last layer zetas[1] manually for InvNTT table
     */

    return 0;
}